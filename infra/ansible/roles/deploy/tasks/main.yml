---
# --- NEW: Wait for SSH connection ---
- name: Wait for SSH connection to be established
  ansible.builtin.wait_for_connection:
    timeout: 120
    delay: 10

# --- Ensure app directory exists ---
- name: Ensure app directory exists
  ansible.builtin.file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0755'
  become: yes

- name: setup ssl cert
  become: true
  shell: |
    curl "https://www.duckdns.org/update?domains=hasmo.duckdns.org&token=e0d700ef-4b13-4244-9b54-2601055f0eb0&ip={{ ansible_host }}"


- name: Clone or update repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes
  become_user: ubuntu
  register: git_result

- name: Build Java application
  shell: |
    cd {{ app_dir }}/users-api
    ./mvnw clean package -DskipTests
  become_user: ubuntu
  when: git_result.changed

# --- Ensure Traefik ACME directory and acme.json exist with correct permissions ---
- name: Ensure Traefik ACME directory exists on host
  ansible.builtin.file:
    path: /opt/todo-app/letsencrypt
    state: directory
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0755'
  become: yes

- name: Ensure acme.json exists with 0600 permissions
  ansible.builtin.file:
    path: /opt/todo-app/letsencrypt/acme.json
    state: touch
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0600'
  become: yes

- name: Create docker network
  become: true
  shell: |
    docker network inspect backend >/dev/null 2>&1 || docker network create backend
  ignore_errors: yes

- name: Stop existing containers
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yaml down
  ignore_errors: yes


- name: Check docker-compose file exists
  become: true
  shell: |
    ls -la {{ app_dir }}/
    ls -la {{ app_dir }}/docker-compose*
  register: compose_files
  ignore_errors: yes

- name: Debug compose files
  debug:
    var: compose_files.stdout_lines

- name: Build and start containers
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yaml up -d --build
  when: git_result.changed

- name: Start containers (if no changes)
  become: true
  shell: |
    cd {{ app_dir }} && docker compose -f docker-compose.yaml up -d
  when: not git_result.changed

- name: Wait for services to be ready
  wait_for:
    port: 80
    host: localhost
    delay: 30
    timeout: 300
  
