---
- name: Ensure application directory exists
  file:
    path: /opt/todo-app
    state: directory
    mode: '0755'

- name: Clone or update application repository
  git:
    repo: "{{ git_repo_url }}"
    dest: /opt/todo-app
    version: main
    force: yes
  register: git_result

- name: Create letsencrypt directory
  file:
    path: /opt/todo-app/letsencrypt
    state: directory
    mode: '0755'

- name: Check if docker-compose.yml exists
  stat:
    path: /opt/todo-app/docker-compose.yml
  register: compose_file

- name: Update docker-compose.yml with domain
  replace:
    path: /opt/todo-app/docker-compose.yml
    regexp: 'your-domain\.com'
    replace: "{{ domain_name }}"
  when: compose_file.stat.exists

- name: Update docker-compose.yml with email
  replace:
    path: /opt/todo-app/docker-compose.yml
    regexp: 'your-email@example\.com'
    replace: "{{ acme_email }}"
  when: compose_file.stat.exists

- name: Pull latest Docker images
  shell: |
    cd /opt/todo-app
    docker compose pull || true
  when: compose_file.stat.exists

- name: Stop existing containers
  shell: |
    cd /opt/todo-app
    docker compose down || true
  when: compose_file.stat.exists

- name: Start application with Docker Compose
  shell: |
    cd /opt/todo-app
    docker compose up -d --build
  when: compose_file.stat.exists
  register: docker_result

- name: Show deployment status
  debug:
    msg: "Application deployed successfully"
  when: docker_result.changed
