---
- name: Create application directory
  file:
    path: /opt/microservices-app
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Clone or update application repository
  git:
    repo: "{{ app_repo_url | default('https://github.com/vicogwa/DevOps-Stage-6.git') }}"
    dest: /opt/microservices-app
    force: yes
    update: yes
  # become_user: "{{ ansible_user }}"
  become: true
  register: git_result

# Important: Use 'absent' only to stop/remove containers
- name: Stop and remove existing containers if code changed
  community.docker.docker_compose_v2:
    project_src: /opt/microservices-app
    state: absent
    remove_volumes: no        # safer â€” keeps DB/data
  when: git_result.changed
  become: true

# Build images and ensure containers are running
- name: Build and start application containers
  community.docker.docker_compose_v2:
    project_src: /opt/microservices-app
    build: always             # ensures rebuild after git update
    state: present
    recreate: always          # ensures clean container update
  become: true

# Wait for the application on port 80
- name: Wait for application to be ready
  wait_for:
    port: 80
    host: "127.0.0.1"
    delay: 5
    timeout: 300
