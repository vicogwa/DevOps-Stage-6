---
- name: Check if application directory exists
  stat:
    path: "{{ app_directory }}"
  register: app_dir

- name: Clone application repository
  git:
    repo: "{{ github_repo_url }}"
    dest: "{{ app_directory }}"
    version: main  
    force: yes
  become: no
  when: not app_dir.stat.exists
  register: git_clone

- name: Pull latest changes from repository
  git:
    repo: "{{ github_repo_url }}"
    dest: "{{ app_directory }}"
    version: main
    force: yes
  become: no
  when: app_dir.stat.exists
  register: git_pull

- name: Create traefik directory
  file:
    path: "{{ app_directory }}/traefik"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  become: no

- name: Create letsencrypt directory
  file:
    path: "{{ app_directory }}/letsencrypt"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  become: no

- name: Create acme.json file with correct permissions
  file:
    path: "{{ app_directory }}/letsencrypt/acme.json"
    state: touch
    owner: ubuntu
    group: ubuntu
    mode: '0600'  
  become: no

- name: Ensure acme.json has correct permissions (if exists)
  file:
    path: "{{ app_directory }}/letsencrypt/acme.json"
    owner: ubuntu
    group: ubuntu
    mode: '0600'
  become: no

- name: Deploy Traefik configuration
  template:
    src: traefik.yml.j2
    dest: "{{ app_directory }}/traefik/traefik.yml"
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: no
  register: traefik_config

- name: Deploy .env file
  template:
    src: .env.j2
    dest: "{{ app_directory }}/.env"
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: no
  register: env_file

- name: Create Docker network
  docker_network:
    name: web
    state: present
  become: no

- name: Stop running containers if configuration changed
  shell: |
    cd {{ app_directory }}
    docker-compose down
  become: no
  when: traefik_config.changed or env_file.changed or git_pull.changed

- name: Pull Docker images
  shell: |
    cd {{ app_directory }}
    docker-compose pull
  become: no
  register: docker_pull
  changed_when: "'Downloaded' in docker_pull.stdout or 'Pulled' in docker_pull.stdout"

- name: Build and start Docker containers
  shell: |
    cd {{ app_directory }}
    docker-compose up -d --build
  become: no
  register: docker_up
  changed_when: "'Creating' in docker_up.stdout or 'Starting' in docker_up.stdout or 'Recreating' in docker_up.stdout"

- name: Wait for services to be healthy
  shell: |
    cd {{ app_directory }}
    docker-compose ps
  become: no
  register: compose_status
  until: compose_status.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Get running containers
  shell: docker ps
  become: no
  register: running_containers
  changed_when: false

- name: Display running containers
  debug:
    var: running_containers.stdout_lines

- name: Verify Traefik is running
  shell: docker logs traefik --tail 20
  become: no
  register: traefik_logs
  changed_when: false

- name: Display Traefik status
  debug:
    msg: "Traefik is running. Check logs for SSL certificate generation."
