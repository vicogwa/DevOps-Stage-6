#!/bin/bash
# Script to import existing AWS resources into Terraform state

cd infra/terraform

# Initialize Terraform
terraform init -migrate-state -force-copy \
  -backend-config="bucket=vicogwa-terraform-state" \
  -backend-config="region=us-east-1" \
  -backend-config="dynamodb_table=vicogwa-state-lock" \
  -backend-config="key=vicogwa/todo-app/terraform.tfstate"

# Import the existing security group
# Get the security group ID first
SG_ID=$(aws ec2 describe-security-groups \
  --filters "Name=group-name,Values=todo-app-security-group" \
  --query 'SecurityGroups[0].GroupId' \
  --output text \
  --region us-east-1)

if [ "$SG_ID" != "None" ] && [ -n "$SG_ID" ]; then
  echo "Found security group: $SG_ID"
  echo "Importing into Terraform state..."
  terraform import aws_security_group.todo_app_sg "$SG_ID"
else
  echo "Security group not found"
fi

# Import the existing EC2 instance if it exists
INSTANCE_ID=$(aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=todo-app-server" "Name=instance-state-name,Values=running" \
  --query 'Reservations[0].Instances[0].InstanceId' \
  --output text \
  --region us-east-1)

if [ "$INSTANCE_ID" != "None" ] && [ -n "$INSTANCE_ID" ]; then
  echo "Found EC2 instance: $INSTANCE_ID"
  echo "Importing into Terraform state..."
  terraform import aws_instance.todo_app_server "$INSTANCE_ID"
else
  echo "EC2 instance not found"
fi

echo "Import complete. Run 'terraform plan' to verify."
